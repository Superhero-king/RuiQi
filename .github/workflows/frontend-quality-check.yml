# .github/workflows/frontend-quality-check.yml (å¹³è¡¡ç‰ˆæœ¬)
name: Frontend Code Quality Check

# ğŸ”’ å·¥ä½œæµçº§æƒé™æ§åˆ¶
permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - "web/**"
      - "*.json"
      - "*.js"
      - "*.ts"
      - "*.tsx"
      - "*.vue"
      - "*.jsx"
  push:
    branches: [main, master, develop]
    paths:
      - "web/**"
      - "*.json"
      - "*.js"
      - "*.ts"
      - "*.tsx"
      - "*.vue"
      - "*.jsx"
  workflow_dispatch:

jobs:
  frontend-check:
    name: Frontend Code Quality Check
    runs-on: ubuntu-latest

    steps:
      # âœ… ä½¿ç”¨å®˜æ–¹æ¨èçš„æœ€æ–°ç¨³å®šç‰ˆæœ¬
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check frontend project
        id: check-frontend
        run: |
          if [ -d "web" ] && [ -f "web/package.json" ]; then
            echo "âœ… å‘ç°å‰ç«¯é¡¹ç›®"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "FRONTEND_EXISTS=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ æœªå‘ç°å‰ç«¯é¡¹ç›®ï¼Œè·³è¿‡å‰ç«¯æ£€æŸ¥"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "FRONTEND_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Setup Node.js
        if: steps.check-frontend.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "23.10.0"

      - name: Install pnpm
        if: steps.check-frontend.outputs.exists == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.5

      - name: Get pnpm store directory
        if: steps.check-frontend.outputs.exists == 'true'
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      # âœ… ä½¿ç”¨ v4 - å®˜æ–¹æ¨èçš„ç¨³å®šç‰ˆæœ¬
      - name: Setup pnpm cache
        if: steps.check-frontend.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Analyze project configuration
        if: steps.check-frontend.outputs.exists == 'true'
        id: analyze-config
        run: |
          cd web
          echo "ğŸ” åˆ†æå‰ç«¯é¡¹ç›®é…ç½®..."

          # æ£€æŸ¥package.jsonä¸­çš„è„šæœ¬
          if grep -q '"lint"' package.json; then
            echo "âœ… å‘ç° lint è„šæœ¬"
            echo "has_lint=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½® lint è„šæœ¬"
            echo "has_lint=false" >> $GITHUB_OUTPUT
          fi

          if grep -q '"test"' package.json; then
            echo "âœ… å‘ç° test è„šæœ¬"
            echo "has_test=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½® test è„šæœ¬"
            echo "has_test=false" >> $GITHUB_OUTPUT
          fi

          if grep -q '"build"' package.json; then
            echo "âœ… å‘ç° build è„šæœ¬"
            echo "has_build=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½® build è„šæœ¬"
            echo "has_build=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥TypeScripté…ç½®
          if [ -f "tsconfig.json" ]; then
            echo "âœ… å‘ç° TypeScript é¡¹ç›®"
            echo "is_typescript=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ é TypeScript é¡¹ç›®"
            echo "is_typescript=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥æ¡†æ¶ç±»å‹
          if grep -q '"vue"' package.json; then
            echo "ğŸ“¦ æ£€æµ‹åˆ° Vue.js é¡¹ç›®"
            echo "framework=vue" >> $GITHUB_OUTPUT
          elif grep -q '"react"' package.json; then
            echo "ğŸ“¦ æ£€æµ‹åˆ° React é¡¹ç›®"
            echo "framework=react" >> $GITHUB_OUTPUT
          elif grep -q '"next"' package.json; then
            echo "ğŸ“¦ æ£€æµ‹åˆ° Next.js é¡¹ç›®"
            echo "framework=nextjs" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ æ™®é€š JavaScript é¡¹ç›®"
            echo "framework=vanilla" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-frontend.outputs.exists == 'true'
        run: |
          cd web
          echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
          # ğŸ”’ ä½¿ç”¨ --frozen-lockfile ç¡®ä¿ä¾èµ–ä¸€è‡´æ€§
          pnpm install --frozen-lockfile
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # è¿è¡Œ ESLint
      - name: Run ESLint
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_lint == 'true'
        run: |
          cd web
          echo "ğŸ” è¿è¡Œ ESLint ä»£ç æ£€æŸ¥..."
          if pnpm lint; then
            echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"
            echo "LINT_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ESLint æ£€æŸ¥å¤±è´¥"
            echo "LINT_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip ESLint (not configured)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_lint == 'false'
        run: |
          echo "âš ï¸ é¡¹ç›®æœªé…ç½® ESLintï¼Œè·³è¿‡ä»£ç æ£€æŸ¥"
          echo "LINT_STATUS=skipped" >> $GITHUB_ENV

      # è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
      - name: Run TypeScript check
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.is_typescript == 'true'
        run: |
          cd web
          echo "ğŸ” è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
          if pnpm tsc --noEmit; then
            echo "âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡"
            echo "TYPECHECK_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥"
            echo "TYPECHECK_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip TypeScript check (not TypeScript project)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.is_typescript == 'false'
        run: |
          echo "â„¹ï¸ é TypeScript é¡¹ç›®ï¼Œè·³è¿‡ç±»å‹æ£€æŸ¥"
          echo "TYPECHECK_STATUS=skipped" >> $GITHUB_ENV

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_test == 'true'
        run: |
          cd web
          echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
          if pnpm test --passWithNoTests; then
            echo "âœ… å‰ç«¯æµ‹è¯•é€šè¿‡"
            echo "TEST_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ å‰ç«¯æµ‹è¯•å¤±è´¥"
            echo "TEST_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip tests (not configured)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_test == 'false'
        run: |
          echo "âš ï¸ é¡¹ç›®æœªé…ç½®æµ‹è¯•ï¼Œè·³è¿‡æµ‹è¯•"
          echo "TEST_STATUS=skipped" >> $GITHUB_ENV

      # æ£€æŸ¥æ„å»º
      - name: Test build
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_build == 'true'
        run: |
          cd web
          echo "ğŸ—ï¸ æµ‹è¯•å‰ç«¯æ„å»º..."
          if pnpm build; then
            echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip build (not configured)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_build == 'false'
        run: |
          echo "âš ï¸ é¡¹ç›®æœªé…ç½®æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ„å»ºæµ‹è¯•"
          echo "BUILD_STATUS=skipped" >> $GITHUB_ENV

      # ğŸ”’ å¯é€‰ï¼šå®‰å…¨å®¡è®¡æ­¥éª¤
      - name: Security Audit
        if: steps.check-frontend.outputs.exists == 'true'
        run: |
          cd web
          echo "ğŸ” è¿è¡Œå®‰å…¨å®¡è®¡..."
          # æ£€æŸ¥å·²çŸ¥æ¼æ´
          if command -v pnpm &> /dev/null; then
            pnpm audit --audit-level moderate || echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥"
          fi
        continue-on-error: true

      # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
      - name: Generate Frontend check summary
        if: always()
        run: |
          echo "## ğŸ¨ å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND_EXISTS" = "false" ]; then
            echo "### â„¹ï¸ é¡¹ç›®çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "æœªå‘ç°å‰ç«¯é¡¹ç›®ï¼Œè·³è¿‡å‰ç«¯ä»£ç æ£€æŸ¥ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å¦‚æœæ‚¨çš„å‰ç«¯ä»£ç ä¸åœ¨ \`web/\` ç›®å½•ä¸‹ï¼Œè¯·è°ƒæ•´å·¥ä½œæµé…ç½®ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ“‹ æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
            
            # ESLintçŠ¶æ€
            case "$LINT_STATUS" in
              "success") echo "| ä»£ç è§„èŒƒ (ESLint) | âœ… é€šè¿‡ | ä»£ç ç¬¦åˆè§„èŒƒ |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| ä»£ç è§„èŒƒ (ESLint) | âŒ å¤±è´¥ | å‘ç°ä»£ç è§„èŒƒé—®é¢˜ |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| ä»£ç è§„èŒƒ (ESLint) | âš ï¸ è·³è¿‡ | æœªé…ç½® lint è„šæœ¬ |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            # TypeScriptçŠ¶æ€
            case "$TYPECHECK_STATUS" in
              "success") echo "| ç±»å‹æ£€æŸ¥ (TypeScript) | âœ… é€šè¿‡ | ç±»å‹å®šä¹‰æ­£ç¡® |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| ç±»å‹æ£€æŸ¥ (TypeScript) | âŒ å¤±è´¥ | å‘ç°ç±»å‹é”™è¯¯ |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| ç±»å‹æ£€æŸ¥ (TypeScript) | âš ï¸ è·³è¿‡ | é TypeScript é¡¹ç›® |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            # æµ‹è¯•çŠ¶æ€
            case "$TEST_STATUS" in
              "success") echo "| å•å…ƒæµ‹è¯• | âœ… é€šè¿‡ | æ‰€æœ‰æµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| å•å…ƒæµ‹è¯• | âŒ å¤±è´¥ | æµ‹è¯•ç”¨ä¾‹å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| å•å…ƒæµ‹è¯• | âš ï¸ è·³è¿‡ | æœªé…ç½®æµ‹è¯•è„šæœ¬ |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            # æ„å»ºçŠ¶æ€
            case "$BUILD_STATUS" in
              "success") echo "| æ„å»ºæµ‹è¯• | âœ… é€šè¿‡ | æ„å»ºæˆåŠŸ |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| æ„å»ºæµ‹è¯• | âŒ å¤±è´¥ | æ„å»ºè¿‡ç¨‹å‡ºé”™ |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| æ„å»ºæµ‹è¯• | âš ï¸ è·³è¿‡ | æœªé…ç½®æ„å»ºè„šæœ¬ |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š é¡¹ç›®ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "- **æ¡†æ¶**: ${{ steps.analyze-config.outputs.framework }}" >> $GITHUB_STEP_SUMMARY
            echo "- **TypeScript**: ${{ steps.analyze-config.outputs.is_typescript == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Node.jsç‰ˆæœ¬**: 23.10.0" >> $GITHUB_STEP_SUMMARY
            echo "- **pnpmç‰ˆæœ¬**: 10.6.5" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š è¿è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ£€æŸ¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # PRè¯„è®ºï¼ˆä»…åœ¨PRæ—¶è¿è¡Œï¼‰
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const frontendExists = process.env.FRONTEND_EXISTS === 'true';
            const success = '${{ job.status }}' === 'success';

            if (!frontendExists) {
              const body = `### ğŸ¨ å‰ç«¯ä»£ç æ£€æŸ¥ â„¹ï¸

              **PR #${{ github.event.pull_request.number }}** æœªå‘ç°å‰ç«¯é¡¹ç›®ï¼Œè·³è¿‡å‰ç«¯ä»£ç æ£€æŸ¥ã€‚

              å¦‚æœæ‚¨çš„å‰ç«¯ä»£ç ä¸åœ¨ \`web/\` ç›®å½•ä¸‹ï¼Œè¯·è°ƒæ•´å·¥ä½œæµé…ç½®ã€‚`;

              // æŸ¥æ‰¾ç°æœ‰è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ğŸ¨ å‰ç«¯ä»£ç æ£€æŸ¥')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
              return;
            }

            const lintStatus = process.env.LINT_STATUS;
            const typecheckStatus = process.env.TYPECHECK_STATUS;
            const testStatus = process.env.TEST_STATUS;
            const buildStatus = process.env.BUILD_STATUS;

            let emoji = success ? 'âœ…' : 'âŒ';
            let status = success ? 'é€šè¿‡' : 'å¤±è´¥';

            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failed': return 'âŒ';
                default: return 'âš ï¸';
              }
            };

            let body = `### ğŸ¨ å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥${status} ${emoji}

            **PR #${{ github.event.pull_request.number }}** çš„å‰ç«¯ä»£ç æ£€æŸ¥å·²å®Œæˆã€‚

            **ğŸ“‹ æ£€æŸ¥ç»“æœ:**
            - ${getStatusIcon(lintStatus)} ä»£ç è§„èŒƒ (ESLint)
            - ${getStatusIcon(typecheckStatus)} ç±»å‹æ£€æŸ¥ (TypeScript)
            - ${getStatusIcon(testStatus)} å•å…ƒæµ‹è¯•
            - ${getStatusIcon(buildStatus)} æ„å»ºæµ‹è¯•

            `;

            if (success) {
              body += `**ğŸ‰ ç»“æœ:** å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼`;
            } else {
              body += `**âš ï¸ éœ€è¦å…³æ³¨:** å‘ç°éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚`;
            }

            // æŸ¥æ‰¾å¹¶æ›´æ–°ç°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¨ å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
