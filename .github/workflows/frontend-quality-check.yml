# .github/workflows/frontend-quality-check.yml (ä¼˜åŒ–å›½é™…åŒ–ç‰ˆæœ¬)
name: Frontend Code Quality Check

# ðŸ”’ å·¥ä½œæµçº§æƒé™æŽ§åˆ¶
permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - "web/**"
      - "*.json"
      - "*.js"
      - "*.ts"
      - "*.tsx"
      - "*.vue"
      - "*.jsx"
  push:
    branches: [main, master, develop]
    paths:
      - "web/**"
      - "*.json"
      - "*.js"
      - "*.ts"
      - "*.tsx"
      - "*.vue"
      - "*.jsx"
  workflow_dispatch:

jobs:
  frontend-check:
    name: Frontend Code Quality Check
    runs-on: ubuntu-latest

    steps:
      # âœ… ä½¿ç”¨å®˜æ–¹æŽ¨èçš„æœ€æ–°ç¨³å®šç‰ˆæœ¬
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check frontend project
        id: check-frontend
        run: |
          if [ -d "web" ] && [ -f "web/package.json" ]; then
            echo "âœ… å‘çŽ°å‰ç«¯é¡¹ç›®"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "FRONTEND_EXISTS=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ æœªå‘çŽ°å‰ç«¯é¡¹ç›®ï¼Œè·³è¿‡å‰ç«¯æ£€æŸ¥"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "FRONTEND_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Setup Node.js
        if: steps.check-frontend.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "23.10.0"

      - name: Install pnpm
        if: steps.check-frontend.outputs.exists == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: Get pnpm store directory
        if: steps.check-frontend.outputs.exists == 'true'
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      # âœ… ä½¿ç”¨ v4 - å®˜æ–¹æŽ¨èçš„ç¨³å®šç‰ˆæœ¬
      - name: Setup pnpm cache
        if: steps.check-frontend.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Analyze project configuration
        if: steps.check-frontend.outputs.exists == 'true'
        id: analyze-config
        run: |
          cd web
          echo "ðŸ” åˆ†æžå‰ç«¯é¡¹ç›®é…ç½®..."

          # æ£€æŸ¥package.jsonä¸­çš„è„šæœ¬
          if grep -q '"lint"' package.json; then
            echo "âœ… å‘çŽ° lint è„šæœ¬"
            echo "has_lint=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½® lint è„šæœ¬"
            echo "has_lint=false" >> $GITHUB_OUTPUT
          fi

          if grep -q '"test"' package.json; then
            echo "âœ… å‘çŽ° test è„šæœ¬"
            echo "has_test=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½® test è„šæœ¬"
            echo "has_test=false" >> $GITHUB_OUTPUT
          fi

          if grep -q '"build"' package.json; then
            echo "âœ… å‘çŽ° build è„šæœ¬"
            echo "has_build=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½® build è„šæœ¬"
            echo "has_build=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥TypeScripté…ç½®
          if [ -f "tsconfig.json" ]; then
            echo "âœ… å‘çŽ° TypeScript é¡¹ç›®"
            echo "is_typescript=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ éž TypeScript é¡¹ç›®"
            echo "is_typescript=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥æ¡†æž¶ç±»åž‹
          if grep -q '"vue"' package.json; then
            echo "ðŸ“¦ æ£€æµ‹åˆ° Vue.js é¡¹ç›®"
            echo "framework=vue" >> $GITHUB_OUTPUT
          elif grep -q '"react"' package.json; then
            echo "ðŸ“¦ æ£€æµ‹åˆ° React é¡¹ç›®"
            echo "framework=react" >> $GITHUB_OUTPUT
          elif grep -q '"next"' package.json; then
            echo "ðŸ“¦ æ£€æµ‹åˆ° Next.js é¡¹ç›®"
            echo "framework=nextjs" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ æ™®é€š JavaScript é¡¹ç›®"
            echo "framework=vanilla" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-frontend.outputs.exists == 'true'
        run: |
          cd web
          echo "ðŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
          # ðŸ”’ ä½¿ç”¨ --frozen-lockfile ç¡®ä¿ä¾èµ–ä¸€è‡´æ€§
          pnpm install --frozen-lockfile
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # è¿è¡Œ ESLint
      - name: Run ESLint
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_lint == 'true'
        run: |
          cd web
          echo "ðŸ” è¿è¡Œ ESLint ä»£ç æ£€æŸ¥..."
          if pnpm lint; then
            echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"
            echo "LINT_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ESLint æ£€æŸ¥å¤±è´¥"
            echo "LINT_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip ESLint (not configured)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_lint == 'false'
        run: |
          echo "âš ï¸ é¡¹ç›®æœªé…ç½® ESLintï¼Œè·³è¿‡ä»£ç æ£€æŸ¥"
          echo "LINT_STATUS=skipped" >> $GITHUB_ENV

      # è¿è¡Œ TypeScript ç±»åž‹æ£€æŸ¥
      - name: Run TypeScript check
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.is_typescript == 'true'
        run: |
          cd web
          echo "ðŸ” è¿è¡Œ TypeScript ç±»åž‹æ£€æŸ¥..."
          if pnpm tsc --noEmit; then
            echo "âœ… TypeScript ç±»åž‹æ£€æŸ¥é€šè¿‡"
            echo "TYPECHECK_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ TypeScript ç±»åž‹æ£€æŸ¥å¤±è´¥"
            echo "TYPECHECK_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip TypeScript check (not TypeScript project)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.is_typescript == 'false'
        run: |
          echo "â„¹ï¸ éž TypeScript é¡¹ç›®ï¼Œè·³è¿‡ç±»åž‹æ£€æŸ¥"
          echo "TYPECHECK_STATUS=skipped" >> $GITHUB_ENV

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_test == 'true'
        run: |
          cd web
          echo "ðŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
          if pnpm test --passWithNoTests; then
            echo "âœ… å‰ç«¯æµ‹è¯•é€šè¿‡"
            echo "TEST_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ å‰ç«¯æµ‹è¯•å¤±è´¥"
            echo "TEST_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip tests (not configured)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_test == 'false'
        run: |
          echo "âš ï¸ é¡¹ç›®æœªé…ç½®æµ‹è¯•ï¼Œè·³è¿‡æµ‹è¯•"
          echo "TEST_STATUS=skipped" >> $GITHUB_ENV

      # æ£€æŸ¥æž„å»º
      - name: Test build
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_build == 'true'
        run: |
          cd web
          echo "ðŸ—ï¸ æµ‹è¯•å‰ç«¯æž„å»º..."
          if pnpm build; then
            echo "âœ… å‰ç«¯æž„å»ºæˆåŠŸ"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ å‰ç«¯æž„å»ºå¤±è´¥"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Skip build (not configured)
        if: steps.check-frontend.outputs.exists == 'true' && steps.analyze-config.outputs.has_build == 'false'
        run: |
          echo "âš ï¸ é¡¹ç›®æœªé…ç½®æž„å»ºè„šæœ¬ï¼Œè·³è¿‡æž„å»ºæµ‹è¯•"
          echo "BUILD_STATUS=skipped" >> $GITHUB_ENV

      # ðŸ”’ å¯é€‰ï¼šå®‰å…¨å®¡è®¡æ­¥éª¤
      - name: Security Audit
        if: steps.check-frontend.outputs.exists == 'true'
        run: |
          cd web
          echo "ðŸ” è¿è¡Œå®‰å…¨å®¡è®¡..."
          # æ£€æŸ¥å·²çŸ¥æ¼æ´ž
          if command -v pnpm &> /dev/null; then
            pnpm audit --audit-level moderate || echo "âš ï¸ å‘çŽ°å®‰å…¨é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥"
          fi
        continue-on-error: true

      # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
      - name: Generate Frontend check summary
        if: always()
        run: |
          echo "## ðŸŽ¨ Frontend Code Quality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND_EXISTS" = "false" ]; then
            echo "### â„¹ï¸ Project Status" >> $GITHUB_STEP_SUMMARY
            echo "No frontend project found, skipping frontend code checks." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "If your frontend code is not in the \`web/\` directory, please adjust the workflow configuration." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“‹ Check Results" >> $GITHUB_STEP_SUMMARY
            echo "| Check Item | Status | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
            
            # ESLintçŠ¶æ€
            case "$LINT_STATUS" in
              "success") echo "| Code Standards (ESLint) | âœ… Passed | Code meets standards |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| Code Standards (ESLint) | âŒ Failed | Found code standard issues |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| Code Standards (ESLint) | âš ï¸ Skipped | No lint script configured |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            # TypeScriptçŠ¶æ€
            case "$TYPECHECK_STATUS" in
              "success") echo "| Type Check (TypeScript) | âœ… Passed | Type definitions correct |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| Type Check (TypeScript) | âŒ Failed | Found type errors |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| Type Check (TypeScript) | âš ï¸ Skipped | Not a TypeScript project |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            # æµ‹è¯•çŠ¶æ€
            case "$TEST_STATUS" in
              "success") echo "| Unit Tests | âœ… Passed | All tests passed |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| Unit Tests | âŒ Failed | Test cases failed |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| Unit Tests | âš ï¸ Skipped | No test script configured |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            # æž„å»ºçŠ¶æ€
            case "$BUILD_STATUS" in
              "success") echo "| Build Test | âœ… Passed | Build successful |" >> $GITHUB_STEP_SUMMARY ;;
              "failed") echo "| Build Test | âŒ Failed | Build process error |" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "| Build Test | âš ï¸ Skipped | No build script configured |" >> $GITHUB_STEP_SUMMARY ;;
            esac
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Project Information" >> $GITHUB_STEP_SUMMARY
            echo "- **Framework**: ${{ steps.analyze-config.outputs.framework }}" >> $GITHUB_STEP_SUMMARY
            echo "- **TypeScript**: ${{ steps.analyze-config.outputs.is_typescript == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Node.js Version**: 23.10.0" >> $GITHUB_STEP_SUMMARY
            echo "- **pnpm Version**: 10.11.0" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Runtime Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # PRè¯„è®ºï¼ˆä»…åœ¨PRæ—¶è¿è¡Œï¼‰
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const frontendExists = process.env.FRONTEND_EXISTS === 'true';
            const success = '${{ job.status }}' === 'success';

            if (!frontendExists) {
              // æž„å»ºæ— å‰ç«¯é¡¹ç›®çš„åŒè¯­æŠ¥å‘Š
              let chineseReport = `### ä¸­æ–‡æŠ¥å‘Š

            **â„¹ï¸ é¡¹ç›®çŠ¶æ€:** æœªå‘çŽ°å‰ç«¯é¡¹ç›®ï¼Œè·³è¿‡å‰ç«¯ä»£ç æ£€æŸ¥ã€‚

            å¦‚æžœæ‚¨çš„å‰ç«¯ä»£ç ä¸åœ¨ \`web/\` ç›®å½•ä¸‹ï¼Œè¯·è°ƒæ•´å·¥ä½œæµé…ç½®ã€‚`;

              let englishReport = `### English Report

            **â„¹ï¸ Project Status:** No frontend project found, skipping frontend code checks.

            If your frontend code is not in the \`web/\` directory, please adjust the workflow configuration.`;

              const body = `## ðŸŽ¨ Frontend Code Quality Check â„¹ï¸

            **PR #${{ github.event.pull_request.number }}** frontend code check completed.

            ${chineseReport}

            ---

            ${englishReport}`;

              // æŸ¥æ‰¾çŽ°æœ‰è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ðŸŽ¨ Frontend Code Quality Check')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
              return;
            }

            const lintStatus = process.env.LINT_STATUS;
            const typecheckStatus = process.env.TYPECHECK_STATUS;
            const testStatus = process.env.TEST_STATUS;
            const buildStatus = process.env.BUILD_STATUS;

            let emoji = success ? 'âœ…' : 'âŒ';
            let statusEn = success ? 'Passed' : 'Failed';
            let statusCn = success ? 'é€šè¿‡' : 'å¤±è´¥';

            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failed': return 'âŒ';
                default: return 'âš ï¸';
              }
            };

            // æž„å»ºä¸­æ–‡æŠ¥å‘Š
            let chineseReport = `### ä¸­æ–‡æŠ¥å‘Š

            **ðŸ“‹ æ£€æŸ¥ç»“æžœ:**
            - ${getStatusIcon(lintStatus)} ä»£ç è§„èŒƒ (ESLint)
            - ${getStatusIcon(typecheckStatus)} ç±»åž‹æ£€æŸ¥ (TypeScript)
            - ${getStatusIcon(testStatus)} å•å…ƒæµ‹è¯•
            - ${getStatusIcon(buildStatus)} æž„å»ºæµ‹è¯•

            `;

            if (success) {
              chineseReport += `**ðŸŽ‰ ç»“æžœ:** å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼`;
            } else {
              chineseReport += `**âš ï¸ éœ€è¦å…³æ³¨:** å‘çŽ°éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚`;
            }

            // æž„å»ºè‹±æ–‡æŠ¥å‘Š
            let englishReport = `### English Report

            **ðŸ“‹ Check Results:**
            - ${getStatusIcon(lintStatus)} Code Standards (ESLint)
            - ${getStatusIcon(typecheckStatus)} Type Check (TypeScript)
            - ${getStatusIcon(testStatus)} Unit Tests
            - ${getStatusIcon(buildStatus)} Build Test

            `;

            if (success) {
              englishReport += `**ðŸŽ‰ Result:** All frontend code quality checks passed!`;
            } else {
              englishReport += `**âš ï¸ Attention Required:** Issues found that need to be fixed. Please check the detailed logs.`;
            }

            // ç»„åˆæœ€ç»ˆå†…å®¹ï¼ˆä¸­æ–‡åœ¨å‰ï¼Œè‹±æ–‡åœ¨åŽï¼‰
            let body = `## ðŸŽ¨ Frontend Code Quality Check ${statusEn} ${emoji}

            **PR #${{ github.event.pull_request.number }}** frontend code check completed.

            ${chineseReport}

            ---

            ${englishReport}`;

            // æŸ¥æ‰¾å¹¶æ›´æ–°çŽ°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸŽ¨ Frontend Code Quality Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }