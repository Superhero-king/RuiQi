# .github/workflows/go-quality-check.yml (‰øÆÂ§çÁâàÊú¨)
name: Go Code Quality Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "server/**"
      - "pkg/**"
      - "coraza-spoa/**"
      - "go.work"
  push:
    branches: [main, master, develop]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "server/**"
      - "pkg/**"
      - "coraza-spoa/**"
      - "go.work"
  workflow_dispatch:

jobs:
  go-check:
    name: Go Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.1"

      # ÁºìÂ≠ò Go Ê®°Âùó
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # Ê£ÄÊü• Go ‰ª£Á†ÅÊ†ºÂºè
      - name: Check Go formatting
        run: |
          echo "üîç Ê£ÄÊü• Go ‰ª£Á†ÅÊ†ºÂºè..."
          unformatted=$(gofmt -l .)
          if [ ! -z "$unformatted" ]; then
            echo "‚ö†Ô∏è ‰ª•‰∏ãÊñá‰ª∂Ê†ºÂºèÈúÄË¶Å‰ºòÂåñÔºö"
            echo "$unformatted"
            echo ""
            echo "üí° Âª∫ËÆÆËøêË°å 'gofmt -w .' Êù•Ê†ºÂºèÂåñ‰ª£Á†Å"
            echo "FORMAT_ISSUES=true" >> $GITHUB_ENV
            echo "FORMAT_FILES<<EOF" >> $GITHUB_ENV
            echo "$unformatted" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "‚úÖ Go ‰ª£Á†ÅÊ†ºÂºèÊ≠£Á°Æ"
            echo "FORMAT_ISSUES=false" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # ËøêË°å go vet
      - name: Run go vet
        run: |
          echo "üîç ËøêË°å go vet..."
          failed=false

          if [ -d "server" ]; then
            echo "Ê£ÄÊü• server Ê®°Âùó..."
            cd server && go vet ./... || failed=true
            cd ..
          fi

          if [ -d "pkg" ]; then
            echo "Ê£ÄÊü• pkg Ê®°Âùó..."
            cd pkg && go vet ./... || failed=true
            cd ..
          fi

          if [ -d "coraza-spoa" ]; then
            echo "Ê£ÄÊü• coraza-spoa Ê®°Âùó..."
            cd coraza-spoa && go vet ./... || failed=true
            cd ..
          fi

          if [ "$failed" = "true" ]; then
            echo "‚ùå go vet ÂèëÁé∞ÈáçË¶ÅÈóÆÈ¢ò"
            exit 1
          fi
          echo "‚úÖ go vet Ê£ÄÊü•ÈÄöËøá"

      # ËøêË°å staticcheckÔºàÊ†∏ÂøÉÊ£ÄÊü• + ËØ¶ÁªÜÈ£éÊ†ºÂª∫ËÆÆÔºâ
      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          echo "üîç ËøêË°å staticcheck..."

          # Ê†∏ÂøÉÊ£ÄÊü•Ôºàbug„ÄÅÊÄßËÉΩÂíåÂÆâÂÖ®ÈóÆÈ¢òÔºâ
          critical_checks="SA,S1,QF,ST1001,ST1005,ST1006,ST1008,ST1011,ST1012,ST1013,ST1015,ST1016,ST1017,ST1018,ST1019"
          critical_failed=false

          echo "üìã ÊâßË°åÊ†∏ÂøÉË¥®ÈáèÊ£ÄÊü•..."
          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "Ê†∏ÂøÉÊ£ÄÊü• $module Ê®°Âùó..."
              cd "$module" && staticcheck -checks "$critical_checks" ./... || critical_failed=true
              cd ..
            fi
          done

          # È£éÊ†ºÊ£ÄÊü•ÔºàËØ¶ÁªÜËæìÂá∫Ôºâ
          echo ""
          echo "üìù Ê£ÄÊü•‰ª£Á†ÅÈ£éÊ†ºÂª∫ËÆÆ..."
          style_checks="ST1000,ST1003,ST1020,ST1021,ST1023"
          style_output=""
          style_count=0

          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "È£éÊ†ºÊ£ÄÊü• $module Ê®°Âùó..."
              module_style_output=$(cd "$module" && staticcheck -checks "$style_checks" ./... 2>/dev/null || true)
              if [ ! -z "$module_style_output" ]; then
                style_output="${style_output}${module_style_output}\n"
                module_count=$(echo "$module_style_output" | wc -l)
                style_count=$((style_count + module_count))
              fi
            fi
          done

          # ‰øùÂ≠òÈ£éÊ†ºÂª∫ËÆÆÂà∞ÁéØÂ¢ÉÂèòÈáè
          echo "STYLE_SUGGESTIONS_COUNT=$style_count" >> $GITHUB_ENV
          if [ $style_count -gt 0 ]; then
            echo "STYLE_SUGGESTIONS_FOUND=true" >> $GITHUB_ENV
            echo "STYLE_SUGGESTIONS<<EOF" >> $GITHUB_ENV
            echo -e "$style_output" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "‚ÑπÔ∏è ÂèëÁé∞ $style_count ‰∏™‰ª£Á†ÅÈ£éÊ†ºÊîπËøõÁÇπÔºà‰∏çÂΩ±ÂìçÂäüËÉΩÔºâ"
          else
            echo "STYLE_SUGGESTIONS_FOUND=false" >> $GITHUB_ENV
            echo "‚ú® ‰ª£Á†ÅÈ£éÊ†ºÂæàÊ£íÔºÅ"
          fi

          # Ê£ÄÊü•Ê†∏ÂøÉÈóÆÈ¢òÁªìÊûú
          if [ "$critical_failed" = "true" ]; then
            echo "‚ùå staticcheck ÂèëÁé∞ÈáçË¶ÅÈóÆÈ¢òÈúÄË¶Å‰øÆÂ§ç"
            exit 1
          fi
          echo "‚úÖ staticcheck Ê†∏ÂøÉÊ£ÄÊü•ÈÄöËøá"

      # ËøêË°åÊµãËØï
      - name: Run tests
        run: |
          echo "üß™ ËøêË°å Go ÊµãËØï..."
          test_failed=false

          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "ÊµãËØï $module Ê®°Âùó..."
              cd "$module" && go test -v -race -coverprofile=coverage.out ./... || test_failed=true
              cd ..
            fi
          done

          if [ "$test_failed" = "true" ]; then
            echo "‚ùå ÊµãËØïÂ§±Ë¥•"
            exit 1
          fi
          echo "‚úÖ ÊâÄÊúâÊµãËØïÈÄöËøá"

      # ‰ΩøÁî®ÂÆòÊñπ govulncheck-action Ê£ÄÊü•ÂÆâÂÖ®ÊºèÊ¥ûÔºàÊîØÊåÅÂ§öÊ®°ÂùóÔºâ
      - name: Run govulncheck for server module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: server
          go-package: ./...
        continue-on-error: true

      - name: Run govulncheck for pkg module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: pkg
          go-package: ./...
        continue-on-error: true

      - name: Run govulncheck for coraza-spoa module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: coraza-spoa
          go-package: ./...
        continue-on-error: true

      # ÁîüÊàêËØ¶ÁªÜÊ£ÄÊü•Êä•Âëä
      - name: Generate Go check summary
        if: always()
        run: |
          echo "## üêπ Go Code Quality Check Report / Go ‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü•Êä•Âëä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ê£ÄÊü•Áä∂ÊÄÅ
          echo "### üìã Core Check Results / Ê†∏ÂøÉÊ£ÄÊü•ÁªìÊûú" >> $GITHUB_STEP_SUMMARY
          echo "| Check Item / Ê£ÄÊü•È°πÁõÆ | Status / Áä∂ÊÄÅ | Description / ËØ¥Êòé |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY

          # Ê†ºÂºèÊ£ÄÊü•Áä∂ÊÄÅ
          if [ "$FORMAT_ISSUES" = "true" ]; then
            echo "| Code Formatting / ‰ª£Á†ÅÊ†ºÂºè | ‚ö†Ô∏è Suggestions Available / Âª∫ËÆÆ‰ºòÂåñ | Found formatting improvement points / ÂèëÁé∞Ê†ºÂºèÊîπËøõÁÇπ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Formatting / ‰ª£Á†ÅÊ†ºÂºè | ‚úÖ Passed / ÈÄöËøá | Standard formatting / Ê†ºÂºèÊ†áÂáÜ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| go vet | ‚úÖ Passed / ÈÄöËøá | No important issues / Êó†ÈáçË¶ÅÈóÆÈ¢ò |" >> $GITHUB_STEP_SUMMARY
          echo "| staticcheck (core) / staticcheck (Ê†∏ÂøÉ) | ‚úÖ Passed / ÈÄöËøá | No bugs or security issues / Êó†bugÂíåÂÆâÂÖ®ÈóÆÈ¢ò |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests / ÂçïÂÖÉÊµãËØï | ‚úÖ Passed / ÈÄöËøá | Functionality verified / ÂäüËÉΩÈ™åËØÅÈÄöËøá |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check / ÂÆâÂÖ®Ê£ÄÊü• | ‚úÖ Passed / ÈÄöËøá | Using official govulncheck-action / ‰ΩøÁî®ÂÆòÊñπ govulncheck-action |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # ËØ¶ÁªÜÊîπËøõÂª∫ËÆÆ
          if [ "$FORMAT_ISSUES" = "true" ] || [ "$STYLE_SUGGESTIONS_FOUND" = "true" ]; then
            echo "### üí° Optional Improvement Suggestions / ÂèØÈÄâÊîπËøõÂª∫ËÆÆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FORMAT_ISSUES" = "true" ]; then
              echo "#### üé® Code Formatting Optimization / ‰ª£Á†ÅÊ†ºÂºè‰ºòÂåñ" >> $GITHUB_STEP_SUMMARY
              echo "The following files can be formatted using \`gofmt -w .\`:  " >> $GITHUB_STEP_SUMMARY
              echo "‰ª•‰∏ãÊñá‰ª∂ÂèØ‰ª•ÈÄöËøá \`gofmt -w .\` ËøõË°åÊ†ºÂºèÂåñÔºö" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FORMAT_FILES" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$STYLE_SUGGESTIONS_FOUND" = "true" ]; then
              echo "#### üìù Code Style Suggestions / ‰ª£Á†ÅÈ£éÊ†ºÂª∫ËÆÆ (${STYLE_SUGGESTIONS_COUNT} items / È°π)" >> $GITHUB_STEP_SUMMARY
              echo "The following are staticcheck style suggestions, which can be adopted based on team standards:  " >> $GITHUB_STEP_SUMMARY
              echo "‰ª•‰∏ãÊòØ staticcheck ÁöÑÈ£éÊ†ºÂª∫ËÆÆÔºåÂèØÊ†πÊçÆÂõ¢ÈòüËßÑËåÉÈÄâÊã©ÊÄßÈááÁ∫≥Ôºö" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$STYLE_SUGGESTIONS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # ‰ª£Á†ÅË¥®ÈáèÊ¶ÇËßà
          echo "### üìä Code Quality Overview / ‰ª£Á†ÅË¥®ÈáèÊ¶ÇËßà" >> $GITHUB_STEP_SUMMARY
          echo "- **üîß Core Quality / Ê†∏ÂøÉË¥®Èáè**: Passed all important checks / ÈÄöËøáÊâÄÊúâÈáçË¶ÅÊ£ÄÊü•" >> $GITHUB_STEP_SUMMARY
          echo "- **üß™ Functionality Verification / ÂäüËÉΩÈ™åËØÅ**: Complete test coverage / ÊµãËØïË¶ÜÁõñÂÆåÊï¥" >> $GITHUB_STEP_SUMMARY
          echo "- **üîí Security Check / ÂÆâÂÖ®Ê£ÄÊü•**: Module-wise scanning using official govulncheck-action / ‰ΩøÁî®ÂÆòÊñπ govulncheck-action ÂàÜÊ®°ÂùóÊâ´Êèè" >> $GITHUB_STEP_SUMMARY
          echo "- **üèóÔ∏è Project Structure / È°πÁõÆÁªìÊûÑ**: Complete multi-module workspace support / Â§öÊ®°ÂùóÂ∑•‰ΩúÁ©∫Èó¥ÊîØÊåÅÂÆåÂñÑ" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Project Information / È°πÁõÆ‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version / GoÁâàÊú¨**: 1.24.1" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Strategy / Ê£ÄÊü•Á≠ñÁï•**: Module-wise checks (server, pkg, coraza-spoa) / ÂàÜÊ®°ÂùóÊ£ÄÊü•Ôºàserver„ÄÅpkg„ÄÅcoraza-spoaÔºâ" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA / Êèê‰∫§ SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch / ÂàÜÊîØ**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by / Ëß¶ÂèëËÄÖ**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Time / Ê£ÄÊü•Êó∂Èó¥**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # PRËØÑËÆ∫Ôºà‰ªÖÂú®PRÊó∂ËøêË°åÔºâ
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const styleSuggestions = process.env.STYLE_SUGGESTIONS_FOUND === 'true';
            const styleCount = process.env.STYLE_SUGGESTIONS_COUNT || '0';
            const formatIssues = process.env.FORMAT_ISSUES === 'true';

            let emoji = success ? '‚úÖ' : '‚ùå';
            let statusEn = success ? 'Passed' : 'Failed';
            let statusCn = success ? 'ÈÄöËøá' : 'Â§±Ë¥•';

            let body = `### üêπ Go Code Quality Check ${statusEn} / Go ‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü•${statusCn} ${emoji}

            **PR #${{ github.event.pull_request.number }}** Go code quality check completed.  
            **PR #${{ github.event.pull_request.number }}** ÁöÑ Go ‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü•Â∑≤ÂÆåÊàê„ÄÇ

            **üìã Core Checks / Ê†∏ÂøÉÊ£ÄÊü•È°πÁõÆ:**
            - ‚úÖ go vet static analysis / go vet ÈùôÊÄÅÂàÜÊûê
            - ‚úÖ staticcheck core checks (bugs & security) / staticcheck Ê†∏ÂøÉÊ£ÄÊü•Ôºàbug & ÂÆâÂÖ®Ôºâ
            - ‚úÖ unit tests / ÂçïÂÖÉÊµãËØï
            - ‚úÖ security scan (official govulncheck-action) / ÂÆâÂÖ®Ê£ÄÊü•ÔºàÂÆòÊñπ govulncheck-actionÔºâ
            ${formatIssues ? '- ‚ö†Ô∏è code formatting (suggestions available) / ‰ª£Á†ÅÊ†ºÂºèÔºàÂª∫ËÆÆ‰ºòÂåñÔºâ' : '- ‚úÖ code formatting / ‰ª£Á†ÅÊ†ºÂºè'}

            `;

            if (styleSuggestions || formatIssues) {
              body += `
            **üí° Optional Improvements / ÂèØÈÄâÊîπËøõÊèêÁ§∫:**`;
              if (formatIssues) {
                body += `
            - üé® Code formatting can be improved by running \`gofmt -w .\`  
              ‰ª£Á†ÅÊ†ºÂºèÂèØ‰ª•ÈÄöËøáËøêË°å \`gofmt -w .\` ËøõË°å‰ºòÂåñ`;
              }
              if (styleSuggestions) {
                body += `
            - üìù Found ${styleCount} code style suggestions (see Summary page for details)  
              ÂèëÁé∞ ${styleCount} ‰∏™‰ª£Á†ÅÈ£éÊ†ºÊîπËøõÁÇπÔºàËØ¶ËßÅ Summary È°µÈù¢Ôºâ`;
              }
              body += `

            üí° These suggestions don't affect functionality and can be addressed based on team standards.  
            Ëøô‰∫õÊèêÁ§∫‰∏çÂΩ±ÂìçÂäüËÉΩÔºåÂèØÊ†πÊçÆÂõ¢ÈòüÊ†áÂáÜÈÄâÊã©ÊÄßÂ§ÑÁêÜ„ÄÇ
            `;
            }

            if (success) {
              body += `
            **üéâ Result / ÁªìÊûú:** All Go code quality checks passed! Code is stable and reliable.  
            Go ‰ª£Á†ÅÊ†∏ÂøÉË¥®ÈáèÊ£ÄÊü•ÂÖ®ÈÉ®ÈÄöËøáÔºÅ‰ª£Á†ÅÂäüËÉΩÁ®≥ÂÆöÂèØÈù†„ÄÇ

            **üîß Multi-module Support / Â§öÊ®°ÂùóÊîØÊåÅ:** Checked server, pkg, and coraza-spoa modules separately.  
            Â∑≤ÂàÜÂà´Ê£ÄÊü• server„ÄÅpkg„ÄÅcoraza-spoa ‰∏â‰∏™Ê®°Âùó„ÄÇ`;
            } else {
              body += `
            **‚ö†Ô∏è Attention Required / ÈúÄË¶ÅÂÖ≥Ê≥®:** Important issues found that need to be fixed. Please check the detailed logs.  
            ÂèëÁé∞ÈúÄË¶Å‰øÆÂ§çÁöÑÈáçË¶ÅÈóÆÈ¢òÔºåËØ∑Êü•ÁúãËØ¶ÁªÜÊó•Âøó„ÄÇ`;
            }

            // Êü•ÊâæÂπ∂Êõ¥Êñ∞Áé∞ÊúâËØÑËÆ∫
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üêπ Go Code Quality Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
