# .github/workflows/go-quality-check.yml (ä¼˜åŒ–å›½é™…åŒ–ç‰ˆæœ¬)
name: Go Code Quality Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "server/**"
      - "pkg/**"
      - "coraza-spoa/**"
      - "go.work"
  push:
    branches: [main, master, develop]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "server/**"
      - "pkg/**"
      - "coraza-spoa/**"
      - "go.work"
  workflow_dispatch:

jobs:
  go-check:
    name: Go Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.1"

      # ç¼“å­˜ Go æ¨¡å—
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # æ£€æŸ¥ Go ä»£ç æ ¼å¼
      - name: Check Go formatting
        run: |
          echo "ðŸ” æ£€æŸ¥ Go ä»£ç æ ¼å¼..."
          unformatted=$(gofmt -l .)
          if [ ! -z "$unformatted" ]; then
            echo "âš ï¸ ä»¥ä¸‹æ–‡ä»¶æ ¼å¼éœ€è¦ä¼˜åŒ–ï¼š"
            echo "$unformatted"
            echo ""
            echo "ðŸ’¡ å»ºè®®è¿è¡Œ 'gofmt -w .' æ¥æ ¼å¼åŒ–ä»£ç "
            echo "FORMAT_ISSUES=true" >> $GITHUB_ENV
            echo "FORMAT_FILES<<EOF" >> $GITHUB_ENV
            echo "$unformatted" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "âœ… Go ä»£ç æ ¼å¼æ­£ç¡®"
            echo "FORMAT_ISSUES=false" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # è¿è¡Œ go vet
      - name: Run go vet
        run: |
          echo "ðŸ” è¿è¡Œ go vet..."
          failed=false

          if [ -d "server" ]; then
            echo "æ£€æŸ¥ server æ¨¡å—..."
            cd server && go vet ./... || failed=true
            cd ..
          fi

          if [ -d "pkg" ]; then
            echo "æ£€æŸ¥ pkg æ¨¡å—..."
            cd pkg && go vet ./... || failed=true
            cd ..
          fi

          if [ -d "coraza-spoa" ]; then
            echo "æ£€æŸ¥ coraza-spoa æ¨¡å—..."
            cd coraza-spoa && go vet ./... || failed=true
            cd ..
          fi

          if [ "$failed" = "true" ]; then
            echo "âŒ go vet å‘çŽ°é‡è¦é—®é¢˜"
            exit 1
          fi
          echo "âœ… go vet æ£€æŸ¥é€šè¿‡"

      # è¿è¡Œ staticcheckï¼ˆæ ¸å¿ƒæ£€æŸ¥ + è¯¦ç»†é£Žæ ¼å»ºè®®ï¼‰
      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          echo "ðŸ” è¿è¡Œ staticcheck..."

          # æ ¸å¿ƒæ£€æŸ¥ï¼ˆbugã€æ€§èƒ½å’Œå®‰å…¨é—®é¢˜ï¼‰
          critical_checks="SA,S1,QF,ST1001,ST1005,ST1006,ST1008,ST1011,ST1012,ST1013,ST1015,ST1016,ST1017,ST1018,ST1019"
          critical_failed=false

          echo "ðŸ“‹ æ‰§è¡Œæ ¸å¿ƒè´¨é‡æ£€æŸ¥..."
          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "æ ¸å¿ƒæ£€æŸ¥ $module æ¨¡å—..."
              cd "$module" && staticcheck -checks "$critical_checks" ./... || critical_failed=true
              cd ..
            fi
          done

          # é£Žæ ¼æ£€æŸ¥ï¼ˆè¯¦ç»†è¾“å‡ºï¼‰
          echo ""
          echo "ðŸ“ æ£€æŸ¥ä»£ç é£Žæ ¼å»ºè®®..."
          style_checks="ST1000,ST1003,ST1020,ST1021,ST1023"
          style_output=""
          style_count=0

          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "é£Žæ ¼æ£€æŸ¥ $module æ¨¡å—..."
              module_style_output=$(cd "$module" && staticcheck -checks "$style_checks" ./... 2>/dev/null || true)
              if [ ! -z "$module_style_output" ]; then
                style_output="${style_output}${module_style_output}\n"
                module_count=$(echo "$module_style_output" | wc -l)
                style_count=$((style_count + module_count))
              fi
            fi
          done

          # ä¿å­˜é£Žæ ¼å»ºè®®åˆ°çŽ¯å¢ƒå˜é‡
          echo "STYLE_SUGGESTIONS_COUNT=$style_count" >> $GITHUB_ENV
          if [ $style_count -gt 0 ]; then
            echo "STYLE_SUGGESTIONS_FOUND=true" >> $GITHUB_ENV
            echo "STYLE_SUGGESTIONS<<EOF" >> $GITHUB_ENV
            echo -e "$style_output" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "â„¹ï¸ å‘çŽ° $style_count ä¸ªä»£ç é£Žæ ¼æ”¹è¿›ç‚¹ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰"
          else
            echo "STYLE_SUGGESTIONS_FOUND=false" >> $GITHUB_ENV
            echo "âœ¨ ä»£ç é£Žæ ¼å¾ˆæ£’ï¼"
          fi

          # æ£€æŸ¥æ ¸å¿ƒé—®é¢˜ç»“æžœ
          if [ "$critical_failed" = "true" ]; then
            echo "âŒ staticcheck å‘çŽ°é‡è¦é—®é¢˜éœ€è¦ä¿®å¤"
            exit 1
          fi
          echo "âœ… staticcheck æ ¸å¿ƒæ£€æŸ¥é€šè¿‡"

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: |
          echo "ðŸ§ª è¿è¡Œ Go æµ‹è¯•..."
          test_failed=false

          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "æµ‹è¯• $module æ¨¡å—..."
              cd "$module" && go test -v -race -coverprofile=coverage.out ./... || test_failed=true
              cd ..
            fi
          done

          if [ "$test_failed" = "true" ]; then
            echo "âŒ æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

      # ä½¿ç”¨å®˜æ–¹ govulncheck-action æ£€æŸ¥å®‰å…¨æ¼æ´žï¼ˆæ”¯æŒå¤šæ¨¡å—ï¼‰
      - name: Run govulncheck for server module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: server
          go-package: ./...
        continue-on-error: true

      - name: Run govulncheck for pkg module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: pkg
          go-package: ./...
        continue-on-error: true

      - name: Run govulncheck for coraza-spoa module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: coraza-spoa
          go-package: ./...
        continue-on-error: true

      # ç”Ÿæˆè¯¦ç»†æ£€æŸ¥æŠ¥å‘Š
      - name: Generate Go check summary
        if: always()
        run: |
          echo "## âš¡ Go Code Quality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥çŠ¶æ€
          echo "### ðŸ“‹ Core Check Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check Item | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY

          # æ ¼å¼æ£€æŸ¥çŠ¶æ€
          if [ "$FORMAT_ISSUES" = "true" ]; then
            echo "| Code Formatting | âš ï¸ Suggestions Available | Found formatting improvement points |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Formatting | âœ… Passed | Standard formatting |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| go vet | âœ… Passed | No important issues |" >> $GITHUB_STEP_SUMMARY
          echo "| staticcheck (core) | âœ… Passed | No bugs or security issues |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | âœ… Passed | Functionality verified |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | âœ… Passed | Using official govulncheck-action |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # è¯¦ç»†æ”¹è¿›å»ºè®®
          if [ "$FORMAT_ISSUES" = "true" ] || [ "$STYLE_SUGGESTIONS_FOUND" = "true" ]; then
            echo "### ðŸ’¡ Optional Improvement Suggestions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FORMAT_ISSUES" = "true" ]; then
              echo "#### ðŸŽ¨ Code Formatting Optimization" >> $GITHUB_STEP_SUMMARY
              echo "The following files can be formatted using \`gofmt -w .\`:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FORMAT_FILES" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$STYLE_SUGGESTIONS_FOUND" = "true" ]; then
              echo "#### ðŸ“ Code Style Suggestions (${STYLE_SUGGESTIONS_COUNT} items)" >> $GITHUB_STEP_SUMMARY
              echo "The following are staticcheck style suggestions, which can be adopted based on team standards:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$STYLE_SUGGESTIONS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # ä»£ç è´¨é‡æ¦‚è§ˆ
          echo "### ðŸ“Š Code Quality Overview" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”§ Core Quality**: Passed all important checks" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ§ª Functionality Verification**: Complete test coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”’ Security Check**: Module-wise scanning using official govulncheck-action" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ—ï¸ Project Structure**: Complete multi-module workspace support" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Project Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: 1.24.1" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Strategy**: Module-wise checks (server, pkg, coraza-spoa)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # PRè¯„è®ºï¼ˆä»…åœ¨PRæ—¶è¿è¡Œï¼‰
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const styleSuggestions = process.env.STYLE_SUGGESTIONS_FOUND === 'true';
            const styleCount = process.env.STYLE_SUGGESTIONS_COUNT || '0';
            const formatIssues = process.env.FORMAT_ISSUES === 'true';

            let emoji = success ? 'âœ…' : 'âŒ';
            let statusEn = success ? 'Passed' : 'Failed';
            let statusCn = success ? 'é€šè¿‡' : 'å¤±è´¥';

            // æž„å»ºè‹±æ–‡æŠ¥å‘Š
            let englishReport = `### English Report

            **ðŸ“‹ Core Checks:**
            - âœ… go vet static analysis
            - âœ… staticcheck core checks (bugs & security)
            - âœ… unit tests
            - âœ… security scan (official govulncheck-action)
            ${formatIssues ? '- âš ï¸ code formatting (suggestions available)' : '- âœ… code formatting'}

            `;

            if (styleSuggestions || formatIssues) {
              englishReport += `**ðŸ’¡ Optional Improvements:**`;
              if (formatIssues) {
                englishReport += `
            - ðŸŽ¨ Code formatting can be improved by running \`gofmt -w .\``;
              }
              if (styleSuggestions) {
                englishReport += `
            - ðŸ“ Found ${styleCount} code style suggestions (see Summary page for details)`;
              }
              englishReport += `

            ðŸ’¡ These suggestions don't affect functionality and can be addressed based on team standards.
            `;
            }

            if (success) {
              englishReport += `
            **ðŸŽ‰ Result:** All Go code quality checks passed! Code is stable and reliable.

            **ðŸ”§ Multi-module Support:** Checked server, pkg, and coraza-spoa modules separately.`;
            } else {
              englishReport += `
            **âš ï¸ Attention Required:** Important issues found that need to be fixed. Please check the detailed logs.`;
            }

            // æž„å»ºä¸­æ–‡æŠ¥å‘Š
            let chineseReport = `### ä¸­æ–‡æŠ¥å‘Š

            **ðŸ“‹ æ ¸å¿ƒæ£€æŸ¥é¡¹ç›®:**
            - âœ… go vet é™æ€åˆ†æž
            - âœ… staticcheck æ ¸å¿ƒæ£€æŸ¥ï¼ˆbug & å®‰å…¨ï¼‰
            - âœ… å•å…ƒæµ‹è¯•
            - âœ… å®‰å…¨æ£€æŸ¥ï¼ˆå®˜æ–¹ govulncheck-actionï¼‰
            ${formatIssues ? '- âš ï¸ ä»£ç æ ¼å¼ï¼ˆå»ºè®®ä¼˜åŒ–ï¼‰' : '- âœ… ä»£ç æ ¼å¼'}

            `;

            if (styleSuggestions || formatIssues) {
              chineseReport += `**ðŸ’¡ å¯é€‰æ”¹è¿›æç¤º:**`;
              if (formatIssues) {
                chineseReport += `
            - ðŸŽ¨ ä»£ç æ ¼å¼å¯ä»¥é€šè¿‡è¿è¡Œ \`gofmt -w .\` è¿›è¡Œä¼˜åŒ–`;
              }
              if (styleSuggestions) {
                chineseReport += `
            - ðŸ“ å‘çŽ° ${styleCount} ä¸ªä»£ç é£Žæ ¼æ”¹è¿›ç‚¹ï¼ˆè¯¦è§ Summary é¡µé¢ï¼‰`;
              }
              chineseReport += `

            ðŸ’¡ è¿™äº›æç¤ºä¸å½±å“åŠŸèƒ½ï¼Œå¯æ ¹æ®å›¢é˜Ÿæ ‡å‡†é€‰æ‹©æ€§å¤„ç†ã€‚
            `;
            }

            if (success) {
              chineseReport += `
            **ðŸŽ‰ ç»“æžœ:** Go ä»£ç æ ¸å¿ƒè´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼ä»£ç åŠŸèƒ½ç¨³å®šå¯é ã€‚

            **ðŸ”§ å¤šæ¨¡å—æ”¯æŒ:** å·²åˆ†åˆ«æ£€æŸ¥ serverã€pkgã€coraza-spoa ä¸‰ä¸ªæ¨¡å—ã€‚`;
            } else {
              chineseReport += `
            **âš ï¸ éœ€è¦å…³æ³¨:** å‘çŽ°éœ€è¦ä¿®å¤çš„é‡è¦é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚`;
            }

            // ç»„åˆæœ€ç»ˆå†…å®¹ï¼ˆä¸­æ–‡ï¼Œè‹±æ–‡ï¼‰
            let body = `## âš¡ Go Code Quality Check ${statusEn} ${emoji}

            **PR #${{ github.event.pull_request.number }}** Go code quality check completed.

            ${chineseReport}

            ---

            ${englishReport}`;

            // æŸ¥æ‰¾å¹¶æ›´æ–°çŽ°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('âš¡ Go Code Quality Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
